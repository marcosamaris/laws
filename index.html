<!doctype html>
<html>

<head>
  <title>Laws</title>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <link href="css/frame.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/controls.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/custom.css" media="screen" rel="stylesheet" type="text/css" />
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
  <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->
  <!-- <script src="js/menu.js"></script> -->
  
  

</head>

<body>

  <div class="menu-container"><div class="menu">
    <div class="menu-table flex-row-space-between">
      <div class="logo flex-row-center">
        <a href="empty.html">Language Annotation Web System - LAWS</a>
      </div>
      
      <div class="menu-items flex-row-center flex-item">
        <a href="/index.html"> Home </a>
        <a href="/pages/openproject.html">Open Project</a>
        <a href="/pages/newproject.html">New Project</a>
        <a href="http://www.linkedin.com/pub/yen-chia-hsu/58/a26/716">Save Project</a>
        <a href="https://twitter.com/yenchiah">Export Liers</a>
      </div>
    </div>
  </div></div>

  
  <div class="content-container">
    <div class="content">
      <div class="content-table flex-column">
        <div class="flex-item flex-column"> 
          <div class="flex-row">
            <div class="flex-item flex-item-stretch flex-column">
              <video height="270" width="430" poster="img/dummay-img.png" class="image">
                <source src="unknown" type="video/*">
              </video>

              <audio height="270" width="430" controls class="image">
                  <source src="unknown" type="audio/*">
              </audio>
        
              <div class="control-group">
                <button type="button" class="custom-button-flat" onclick="filePreviousFinal()"><img src="img/previous_final.png"></button>
                <button type="button" class="custom-button-flat" onclick="filePreviousEnquadrament()"><img src="img/previous_enquedrament.png"></button>
                <button type="button" class="custom-button-flat" onclick="filePreviousSecond()"><img src="img/previous_1_second.png"></button>
                <button type="button" class="custom-button-flat" onclick="filePreviousFrame()"><img src="img/previous_frame.png"></button>
                <button type="button" class="custom-button-flat" onclick="filePreviousPixel()"><img src="img/previous_pixel.png"></button>
                <button type="button" class="custom-button-flat" onclick="filePlayPause()" id="play_pause"><img src="img/play_.png"></button>
                <button type="button" class="custom-button-flat" onclick="fileNextPixel()"><img src="img/next_pixel.png"></button>
                <button type="button" class="custom-button-flat" onclick="fileNextFrame()"><img src="img/next_frame.png"></button>
                <button type="button" class="custom-button-flat" onclick="fileNextSecond()"><img src="img/next_1_second.png"></button>
                <button type="button" class="custom-button-flat" onclick="fileNextEnquadrament()"><img src="img/next_enquedrament.png"></button>
                <button type="button" class="custom-button-flat" onclick="fileNextFinal()"><img src="img/next_final.png"></button>
              </div>
            </div>
            <form>          
              <div class="flex-item flex-column">
                <p class="text text-large" id="inputs">
                  
                  Video: <input type="file" accept="video/*" name="video" class="file_here"><br>  
                  Audio: <input type="file" accept="audio/*" name="audio" class="file_here"><br>                
                  Open: <input type="file" accept=".eaf" name="file" class="file_here"><br>  
                  <input type="button" value="Submit" onclick="loadFile()">
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="column column-one">
      <li id="tag-li-media"></li>
    </div>
    <div class="column column-two">
      <div id="waveform"><!-- Here be waveform --></div>
      <div id="wave-timeline"></div>
    </div>
  </div>

  <iframe src="/frames/frame-trilhas.html" frameborder="1" id="iframe-trilhas"></iframe>
  
  <div class="row">
    <div class="column column-one" id = "divrow1">
      
    </div>  
  </div>

  
  <script>

    var wavesurfer = WaveSurfer.create({
        container: document.querySelector('#waveform'),
        waveColor: '#000000',
        progressColor: '#f1f1f1',
        plugins: [
          WaveSurfer.timeline.create({
              container: "#wave-timeline",
              
          })
        ],
        backend: 'MediaElement'
    });

    function loadFile(){
      
      var video = document.querySelector('video');
      var audio = document.querySelector('audio');
      var file = document.getElementsByClassName('file_here');
      var element_Li = document.getElementById("tag-li-media");
      var inputs = document.getElementById('inputs');  
      inputs.style.display='none';

      wavesurfer.setCursorColor();
      
      reader = new FileReader();
      reader.onloadend = function() {
        if(file[0].files.length == 1){
          video.src = reader.result;
          video.play();
          wavesurfer.load(video);
          //wavesurfer.play();
          document.querySelector("audio").style.display = "none";
          element_Li.textContent=file[0].files[0].name

          
        }
        else if(file[1].files.length == 1){
          audio.src = reader.result;
          audio.play();
          
          wavesurfer.load(audio);
          //wavesurfer.play();
          //document.querySelector("video").style.display = "none";
          element_Li.textContent=file[1].files[0].name
          
        }
        else if(file[2].files.length == 1){
          getXmlFile(reader.result, function(xml){
            var urlVideo;
            var urlAudio;
            var element_LiText;
            var time_slot_id=[]
            var time_value=[]
            
            //extrai url do video
            if(xml.getElementsByTagName("MEDIA_DESCRIPTOR")[0].attributes[0].name=="MEDIA_URL"){
              urlVideo=xml.getElementsByTagName("MEDIA_DESCRIPTOR")[0].attributes[0].value;
              //title the video
              element_LiText=xml.getElementsByTagName("MEDIA_DESCRIPTOR")[0].attributes[2].value;
              element_Li.textContent = String(element_LiText).replace("./", "");

            }
            //extrai url do audio
            if(xml.getElementsByTagName("MEDIA_DESCRIPTOR")[1].attributes[1].name=="MEDIA_URL")
              urlAudio=xml.getElementsByTagName("MEDIA_DESCRIPTOR")[1].attributes[1].value;
            

            //extrai as marcações dos tempos
            for (const i of xml.getElementsByTagName("TIME_SLOT")) {
              time_slot_id.push(i.attributes[0].value)
              time_value.push(i.attributes[1].value)              
            }

            var trilhas=xml.getElementsByTagName("TIER");         
            var participant;
            var type_ref;
            var tier_id;
            var parent_ref;
            var column_one = document.getElementById("divrow1");
            var column_two = document.getElementById("divrow2");
            var labeltransc;
            var labelwords;
            var labeltransl;
            var labelpartic;
            
            

            console.log(column_one)
            //extrai as trilhas
            for (const i of trilhas) {
              for (const j of i.attributes) {
                switch(String(j.name)){
                  case "LINGUISTIC_TYPE_REF":
                    type_ref=j.value;
                    break;
                  case "PARTICIPANT":
                    participant=new String(j.value);
                    break;
                  case "TIER_ID":
                    tier_id=new String(j.value);
                    break;
                  case "PARENT_REF":
                    parent_ref=new String(j.value);
                    break;
                }
                
              }
              
              if(type_ref == "Phrases"){
                //var transcription= document.getElementById("transcription");
                labeltransc = `<li>${tier_id}</li>`;
                var annotation = i.getElementsByTagName("ANNOTATION_VALUE");
                console.log(type_ref + " " + tier_id)
                for (const phrases_annotation of annotation) {
                  //transcription.value = phrases_annotation.innerHTML;
                }
              }

              if(type_ref=="Words"){
                //var words = document.getElementById("words");
                labelwords = `<li>${tier_id}</li>`;
                var annotationWords = i.getElementsByTagName("ANNOTATION_VALUE")
                var wordsConcat = new String();
                for (const words_annotation of annotationWords) {
                  wordsConcat += words_annotation.innerHTML + " | "
                  //words.value=wordsConcat
                }
              }

              if(type_ref=="Note" && tier_id.search("Translation") != -1){
                //var note = document.getElementById("translation");
                labeltransl = `<li>${tier_id}</li>`;
                var annotationNote = i.getElementsByTagName("ANNOTATION_VALUE")
                for (const note_annotation of annotationNote) {
                  //note.value = note_annotation.innerHTML;
                }
              }

              if(type_ref=="Note" && tier_id.search("Participant-note")!=-1){
                //var noteParticipant = document.getElementById("participant");
                labelpartic = `<li>${tier_id}</li>`;
                var annotationnoteParticipant = i.getElementsByTagName("ANNOTATION_VALUE")
                for (const noteParticipant_annotation of annotationnoteParticipant) {
                  //noteParticipant.value = noteParticipant_annotation.innerHTML;
                }
              }
            }
            column_one.innerHTML = labeltransc+
                                    labelwords+
                                    labeltransl+
                                    labelpartic;
            
            console.log(column_one)
            var iframe = document.getElementById("iframe-trilhas");
            console.log(iframe.contentWindow.document)
            
            video.src=urlVideo;
            wavesurfer.load(video);
            //wavesurfer.play();
            //video.play();
            
            
            
          });

        }
        
      }
      
      if (file[0].files[0]){
        reader.readAsDataURL(file[0].files[0]);
      }
      else if (file[1].files[0]){
        reader.readAsDataURL(file[1].files[0]);
      }
      else if (file[2].files[0]){
        reader.readAsDataURL(file[2].files[0]);
      }
      else{
        video.src="";
      }
      
    }

    function filePause(){
      video = document.querySelector('video');
      if(video.src){
        video.pause();
        console.log(video.controller);
      }
    }

    function filePlayPause(){
      var play = false;
      var img = document.getElementById("play_pause");
      video = document.querySelector('video');
      if(video.src){
        video.play();
        img.innerHTML = `<img src="img/pause.png">`
      }
    }
    
    function fileNextPixel(){    }
    function fileNextFrame(){    }
    function fileNextSecond(){
      wavesurfer.setCurrentTime(wavesurfer.getCurrentTime()+1);
    }
    function fileNextEnquadrament(){    }
    function fileNextFinal(){    }
    function filePreviousPixel(){
      
    }
    function filePreviousFrame(){    }
    function filePreviousSecond(){
      wavesurfer.setCurrentTime(wavesurfer.getCurrentTime()-1);
    }
    function filePreviousEnquadrament(){    }
    function filePreviousFinal(){    }

    let getXmlFile = function(path, callback) {
      let request = new XMLHttpRequest();
      request.open("GET", path);
      request.setRequestHeader("Content-Type", "text/xml");
      request.onreadystatechange = function(){
        if(request.readyState == 4 && request.status ===200){
          callback(request.responseXML);
        }
      };
      request.send();
    };

  </script>
</body>

</html>
